<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title> Alphafold structure prediction </title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
      }
      html, body {
        width: 100%;
      }
      body {
        font-family: 'Ubuntu', sans-serif;
      }
      canvas {
        background-color: white;
      }
      h1, h2, h3, h4, h5, h6 {
        color: dodgerblue;
        text-align: center;
        font-weight: lighter;
      }
      h1 {
        margin: 2rem;
      }
      button.btn {
        color: #ccc;
        margin: 1rem;
        padding: .5rem;
        font-size: 1.5rem;
        border: none;
        border-radius: .5rem;
        background-color: grey;
        transition-duration: 0.25s;
        cursor: pointer;
      }
      button.btn.selected {
        color: #eee;
        background-color: dodgerblue;
      }
      button.btn.green {
        color: #eee;
        background-color: #10941f;
      }
      button.btn:focus {
        outline: none;
        color: inherit;
      }
      button.btn:hover {
        color: white;
        box-shadow: 0 0 10px dodgerblue;
      }
      button.btn.green:hover {
        color: white;
        box-shadow: 0 0 10px limegreen;
      }
      .main {
        min-height: 90vh;
        position: relative;
      }
      .flex {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
      }
      .col {
        flex-direction: column;
      }
      .box {
        padding: 1rem;
        margin: 1rem auto;
        width: fit-content;
        border-radius: 1rem;
      }
      .box.blue {
        background-color: #e0e6f0;
        border: 1px solid dodgerblue;
      }
      .box.green {
        background-color: #e6f0e0;
        border-color: forestgreen;
      }
      .text-center {
        text-align: center;
      }
      .mono {
        font-family: monospace;
        color: #555;
        background-color: #ddd;
        padding: .25rem 1rem;
        border-radius: .25rem;
      }
      .space-1 {
        line-height: 1.2;
      }
      .space-1 {
        line-height: 1.5;
      }
      .relative {
        position: relative;
      }
      #ngl-root {
        width: 800px;
        height: 600px;
        border-radius: 15px;
        border: 1px solid grey;
      }
      #ngl-loading {
        position: absolute;
        top: 28%;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 800px;
        height: 600px;
      }
      #ngl-loading svg {
        width: 30%;
        height: 30%;
      }
    </style>

    <script src="https://cdn.rawgit.com/arose/ngl/v2.0.0-dev.37/dist/ngl.js"></script>
  </head>


  <body>
    <h1> AlphaFold results </h1>

    <div class="main flex">
      <div>
        <div id="ngl-root"></div>

        <div id="ngl-loading">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="margin: auto; background: none; display: block; shape-rendering: auto;" width="200px" height="200px" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
            <g transform="rotate(0 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.9166666666666666s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(30 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.8333333333333334s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(60 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.75s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(90 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.6666666666666666s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(120 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5833333333333334s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(150 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.5s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(180 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.4166666666666667s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(210 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.3333333333333333s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(240 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.25s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(270 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.16666666666666666s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(300 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="-0.08333333333333333s" repeatCount="indefinite"></animate>
              </rect>
            </g><g transform="rotate(330 50 50)">
              <rect x="47" y="24" rx="3" ry="6" width="6" height="12" fill="#88879e">
                <animate attributeName="opacity" values="1;0" keyTimes="0;1" dur="1s" begin="0s" repeatCount="indefinite"></animate>
              </rect>
            </g>
          </svg>
        </div>

        <div class="box space-1">
          <p>
            <span class="mono">Click + drag</span>
            to rotate the structure
          </p>
          <p>
            <span class="mono">CTRL + click + drag</span>
            to move the structure
          </p>
          <p>
            <span class="mono">Scroll up/down</span>
            to zoom in and out
          </p>
        </div>
      </div>

      <div class="flex col">
        <div class="box text-center">
          <h2> Models </h2>
          <p>The top five models predicted by Alphafold</p>
          <div>
            <button class="btn selected" id="btn-ranked_0" onclick="setModel(0);">
              ranked_0
            </button>

            <button class="btn" id="btn-ranked_1" onclick="setModel(1);">
              ranked_1
            </button>

            <button class="btn" id="btn-ranked_2" onclick="setModel(2);">
              ranked_2
            </button>

            <button class="btn" id="btn-ranked_3" onclick="setModel(3);">
              ranked_3
            </button>

            <button class="btn" id="btn-ranked_4" onclick="setModel(4);">
              ranked_4
            </button>
          </div>
        </div>

        <div class="box text-center">
          <h2> Representations </h2>
          <div>
            <button class="btn selected" id="btn-cartoon" onclick="toggleModelRepresentation('cartoon');">
              Cartoon
            </button>

            <button class="btn" id="btn-ball-stick" onclick="toggleModelRepresentation('ball+stick');">
              Ball + stick
            </button>

            <button class="btn" id="btn-surface" onclick="toggleModelRepresentation('surface');">
              Surface
            </button>

            <button class="btn" id="btn-backbone" onclick="toggleModelRepresentation('backbone');">
              Backbone
            </button>
          </div>
        </div>

        <div class="box text-center">
          <h2> Actions </h2>
          <div>
            <button class="btn selected" id="btn-toggle-spin" onclick="toggleSpin();">
              Toggle spin
            </button>

            <button class="btn" id="btn-toggle-dark" onclick="toggleDark();">
              Dark mode
            </button>

            <br>

            <button class="btn green" onclick="downloadPng();">
              Download image
            </button>

            <button class="btn green" onclick="downloadPdb();">
              Download PDB
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>


  <script type="text/javascript">

    // Render NGLviewer for PDB files

    // State management has been implemented with vanilla Js but could have used
    // Vue - it's a fairly simple use case so a global 'state' object works fine
    // without complicating things too much.

    const MODELS = [
      'ranked_0.pdb',
      'ranked_1.pdb',
      'ranked_2.pdb',
      'ranked_3.pdb',
      'ranked_4.pdb',
    ]

    const BUTTONS = [
      'cartoon',
      'ball+stick',
      'surface',
      'backbone',
    ]

    const DEFAULT_REPRESENTATION = BUTTONS[0];

    let stage;

    let state = {
      model: 0,
      modelObject: null,
      representations: {},
      colorScheme: 'bfactor',
      darkMode: false,
      spin: true,
    }

    // const uri = "rcsb://1crn";
    const uri = (i) => MODELS[i];

    document.addEventListener("DOMContentLoaded", async function () {
      // Create NGL Stage object
      stage = new NGL.Stage("ngl-root", { backgroundColor: 'white' });

      // Handle window resizing
      window.addEventListener( "resize", function( event ){
          stage.handleResize();
      }, false );

      loadModel();
    });

    // Models ----------------------------------------------------------------------

    const setModel = (ix) => {
      state.model = ix;
      stage.removeComponent(state.modelObject);
      loadModel();
      updateButtons();
    }

    const loadModel = () => {
      setLoading(1);
      reps = Object.keys(state.representations);
      if (reps.length) {
        clearModelRepresentations();
      } else {
        reps = [DEFAULT_REPRESENTATION];
      }

      // Load PDB entry
      return stage.loadFile(uri(state.model)).then( (o) => {
        state.modelObject = o;
        reps.forEach( (r) => addModelRepresentation(r) );
        stage.setSpin(state.spin);
        o.autoView();
        setLoading(0);
      })
    }

    // Representations -------------------------------------------------------------

    const toggleModelRepresentation = (rep) => {
      rep in state.representations ?
        removeModelRepresentation(rep)
        : addModelRepresentation(rep)
    }

    const addModelRepresentation = (rep) => {
      state.representations[rep] =
        state.modelObject.addRepresentation(rep, {colorScheme: "bfactor"});
      updateButtons();
    }

    const removeModelRepresentation = (rep) => {
      o = state.representations[rep];
      state.modelObject.removeRepresentation(o);
      delete state.representations[rep];
      updateButtons();
    }

    const clearModelRepresentations = () => {
      state.modelObject && state.modelObject.removeAllRepresentations();
      state.representations = {};
    }

    // Actions ---------------------------------------------------------------------

    const toggleDark = () => {
      state.darkMode = !state.darkMode;
      stage.setParameters({
        backgroundColor: state.darkMode ? 'black' : 'white',
      });
      const btn = document.querySelector('#btn-toggle-dark');
      btn && btn.classList.toggle('selected');
    }

    const setLoading = (state) => {
      document.getElementById('ngl-loading')
        .style.display = state ? 'block' : 'none';
    }

    const toggleSpin = () => {
      stage.toggleSpin();
      const btn = document.querySelector('#btn-toggle-spin');
      btn && btn.classList.toggle('selected');
      state.spin = !state.spin;
    }

    const downloadPng = () => {
      const params = {
        factor: 3,
        antialias: true,
      }
      stage.makeImage(params).then( (blob) => {
        const name = MODELS[state.model].replace('.pdb', '.png');
        const url = URL.createObjectURL(blob);
        makeDownload(url, name);
      })
    }

    const downloadPdb = () => {
      const url = uri(state.model);
      const name = `alphafold_${MODELS[state.model]}`;
      makeDownload(url, name);
    }

    const makeDownload = (url, name) => {
      // Will not work with cross-origin urls (i.e. during development)
      const saveLink = document.createElement('a');
      saveLink.href = url;
      saveLink.download = name;
      document.body.appendChild(saveLink);
      saveLink.dispatchEvent(
        new MouseEvent('click', {
          bubbles: true,
          cancelable: true,
          view: window
        })
      );
      document.body.removeChild(saveLink);
    }

    const updateButtons = () => {
      MODELS.forEach( (name, i) => {
        const id = `#btn-${name.replace('.pdb', '')}`;
        const btn = document.querySelector(id);
        if (!btn) return
        i == state.model ?
          btn.classList.add('selected')
          : btn.classList.remove('selected');
      })

      BUTTONS.forEach( (name) => {
        const id = `#btn-${name}`.replace('+', '-');
        const btn = document.querySelector(id);
        if (!btn) return
        if (name in state.representations) {
          btn.classList.add('selected')
        } else {
          btn.classList.remove('selected');
        }
      });
    }

  </script>


</html>
